from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.routers import keys, addresses, balance, utxo, broadcast, fee, sign, validate, tx
from app.dependencies import get_network, setup_logging, get_settings
import logging

logger = setup_logging()
settings = get_settings()

api_description = """
# Bitcoin Wallet API

API completa para gerenciamento de carteiras Bitcoin, oferecendo suporte a diferentes formatos de endere√ßos, gera√ß√£o de chaves, 
e opera√ß√µes completas com transa√ß√µes.

## üîë Caracter√≠sticas Principais

* **Gera√ß√£o de Chaves Bitcoin**: Suporte a m√∫ltiplos m√©todos (entropy, BIP39, BIP32)
* **M√∫ltiplos Formatos de Endere√ßos**: Legacy (P2PKH), SegWit (P2SH), Native SegWit (P2WPKH) e Taproot (P2TR)
* **Opera√ß√µes com Transa√ß√µes**: Constru√ß√£o, assinatura, valida√ß√£o e transmiss√£o
* **Consulta de Saldo e UTXOs**: Para qualquer endere√ßo na rede
* **Estimativa de Taxas**: Baseada em condi√ß√µes da mempool atual
* **Verifica√ß√£o de Status**: Acompanhamento de transa√ß√µes na blockchain

## üîß Exemplos de Uso

### Fluxo B√°sico de Transa√ß√£o

1. **Gerar Chaves**:
   ```bash
   POST /api/keys
   ```

2. **Obter Saldo e UTXOs**:
   ```bash
   GET /api/balance/{endere√ßo}
   ```

3. **Construir Transa√ß√£o**:
   ```bash
   POST /api/utxo
   ```

4. **Assinar Transa√ß√£o**:
   ```bash
   POST /api/sign
   ```

5. **Transmitir Transa√ß√£o**:
   ```bash
   POST /api/broadcast
   ```

6. **Verificar Status**:
   ```bash
   GET /api/tx/{txid}
   ```

## üìã Redes Suportadas

* **Testnet**: Para testes sem usar bitcoins reais
* **Mainnet**: Para opera√ß√µes com bitcoins reais

## üõ°Ô∏è Seguran√ßa

* Chaves privadas s√£o processadas apenas localmente
* Nenhuma chave privada √© armazenada nos servidores
* Comunica√ß√£o via HTTPS recomendada para uso em produ√ß√£o

## üß™ Ambiente de Teste

Use a testnet para experimentar a API sem arriscar fundos reais.

## üìö Requisitos T√©cnicos

* Python 3.8+
* Depend√™ncias detalhadas em `requirements.txt`
* Configura√ß√µes via arquivo `.env` ou vari√°veis de ambiente

## üìù Licen√ßa

Este projeto est√° licenciado sob a licen√ßa MIT.
"""

app = FastAPI(
    title="Bitcoin Wallet API",
    description=api_description,
    version="1.0.0",
    contact={
        "name": "Desenvolvedor Bitcoin Wallet",
        "url": "https://github.com/RenanOliveira04/bitcoin-wallet",
    },
    license_info={
        "name": "MIT License",
        "url": "https://opensource.org/licenses/MIT",
    },
    docs_url="/docs",
    redoc_url="/redoc",
    openapi_tags=[
        {
            "name": "Chaves",
            "description": "Opera√ß√µes relacionadas √† gera√ß√£o e gerenciamento de chaves Bitcoin"
        },
        {
            "name": "Endere√ßos",
            "description": "Gera√ß√£o de endere√ßos em diferentes formatos a partir de chaves privadas"
        },
        {
            "name": "Saldo e UTXOs",
            "description": "Consulta de saldo e UTXOs dispon√≠veis para um endere√ßo Bitcoin"
        },
        {
            "name": "Transa√ß√µes",
            "description": "Constru√ß√£o, assinatura, valida√ß√£o e transmiss√£o de transa√ß√µes Bitcoin"
        },
        {
            "name": "Taxas",
            "description": "Estimativa de taxas baseada nas condi√ß√µes atuais da mempool"
        },
        {
            "name": "Status",
            "description": "Verifica√ß√£o do status de transa√ß√µes na blockchain"
        }
    ]
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# Rotas
app.include_router(keys.router, prefix="/api/keys", tags=["Chaves"])
app.include_router(addresses.router, prefix="/api/addresses", tags=["Endere√ßos"])
app.include_router(balance.router, prefix="/api/balance", tags=["Saldo e UTXOs"])
app.include_router(utxo.router, prefix="/api/utxo", tags=["Transa√ß√µes"])
app.include_router(broadcast.router, prefix="/api/broadcast", tags=["Transa√ß√µes"])
app.include_router(fee.router, prefix="/api/fee", tags=["Taxas"])
app.include_router(sign.router, prefix="/api/sign", tags=["Transa√ß√µes"])
app.include_router(validate.router, prefix="/api/validate", tags=["Transa√ß√µes"])
app.include_router(tx.router, prefix="/api/tx", tags=["Status"])


@app.get("/", tags=["Status"], summary="Verifica o status da API", 
         description="Endpoint de health check que retorna o status atual da API, a rede configurada e outras informa√ß√µes essenciais.")
def read_root():
    logger.info("Health check realizado")
    return {
        "status": "running",
        "network": get_network(),
        "default_key_type": settings.default_key_type,
        "version": "1.0.0"
    }

@app.on_event("startup")
async def startup_event():
    """Executado quando a aplica√ß√£o inicia"""
    logger.info(f"Iniciando API Bitcoin Wallet na rede {get_network()}")
    logger.info(f"Tipo de chave padr√£o: {settings.default_key_type}")
    
    if settings.blockchain_api_url:
        logger.info("Blockchain API URL configurada")
    else:
        logger.warning("Blockchain API URL n√£o configurada - usando valor padr√£o")
        
    if settings.mempool_api_url:
        logger.info("Mempool API URL configurada")
    else:
        logger.warning("Mempool API URL n√£o configurada - usando valor padr√£o")
        
    if settings.api_key:
        logger.info("API Key configurada")
    
    logger.info(f"N√≠vel de log: {settings.log_level}")
    logger.info(f"Tempo de cache: {settings.cache_timeout} segundos")